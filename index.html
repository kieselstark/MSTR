<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MSTR Live-Chart</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
      background: #f4f4f4;
    }
    #chartContainer {
      background: white;
      border-radius: 10px;
      padding: 1rem;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    canvas {
      width: 100% !important;
      height: auto !important;
    }
  </style>
</head>
<body>
  <h1>MSTR Live-Chart (echte Daten)</h1>
  <div id="chartContainer">
    <canvas id="mstrChart"></canvas>
  </div>

  <script>
    async function fetchMSTRData() {
      const proxyUrl = "https://query1.finance.yahoo.com/v8/finance/chart/MSTR?range=1y&interval=1d";
      const res = await fetch(proxyUrl);
      const data = await res.json();
      const chartData = data.chart.result[0];
      const timestamps = chartData.timestamp;
      const prices = chartData.indicators.adjclose[0].adjclose;

      const labels = timestamps.map(t =>
        new Date(t * 1000).toISOString().split("T")[0]
      );

      const pricesClean = prices.map((v, i) => ({
        date: labels[i],
        price: v,
      }));

      // 200-Tage-SMA berechnen
      function calcSMA(data, windowSize) {
        const sma = [];
        for (let i = 0; i < data.length; i++) {
          if (i < windowSize - 1) {
            sma.push(null);
          } else {
            const slice = data.slice(i - windowSize + 1, i + 1);
            const avg =
              slice.reduce((sum, val) => sum + val.price, 0) / windowSize;
            sma.push(avg);
          }
        }
        return sma;
      }

      const sma200 = calcSMA(pricesClean, 200);

      // Chart.js anzeigen
      const ctx = document.getElementById("mstrChart").getContext("2d");
      new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: "MSTR Kurs",
              data: prices,
              borderColor: "#1d72b8",
              backgroundColor: "rgba(29, 114, 184, 0.1)",
              fill: true,
              pointRadius: 0,
              tension: 0.1,
            },
            {
              label: "200-Tage-Durchschnitt",
              data: sma200,
              borderColor: "orange",
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.1,
            }
          ],
        },
        options: {
          responsive: true,
          scales: {
            x: {
              ticks: {
                maxTicksLimit: 10
              }
            },
            y: {
              beginAtZero: false
            }
          },
          plugins: {
            legend: {
              position: "top"
            },
            title: {
              display: true,
              text: "MicroStrategy Inc. (MSTR) â€“ 1 Jahr"
            }
          }
        }
      });
    }

    fetchMSTRData();
  </script>
</body>
</html>
